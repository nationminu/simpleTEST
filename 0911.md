# 0911

1. Built-in Handler

console-handler : 표준출력에 대한 로깅

periodic-rotating-file-handler : 일별 로테이션 로깅

 
2. 변경방법
1) 관리콘솔

화면메뉴: Profile - Core - Logging
2) standalone.xml
<console-handler name="CONSOLE">
    <level name="INFO"/>
    <formatter>
        <pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/>
    </formatter>
</console-handler>
<periodic-rotating-file-handler name="FILE">
    <level name="INFO"/>
    <formatter>
        <pattern-formatter pattern="%d{HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/>
    </formatter>
    <file relative-to="jboss.server.log.dir" path="server.log"/>
    <suffix value=".yyyy-MM-dd"/>
    <append value="true"/>
</periodic-rotating-file-handler>

 
3) Logger추가

아래 설정은 org.jboss.as.clustering.web.infinispan 패키지에 대한 로그를 TRACE 레벨로 추가하여 로그파일에 기록한다.
[domain@192.168.101.20:9999 /] /profile=ha/subsystem=logging/logger=org.jboss.as.clustering.web.infinispan:add
[domain@192.168.101.20:9999 /] /profile=ha/subsystem=logging/logger=org.jboss.as.clustering.web.infinispan:write-attribute(name=level,value=TRACE)
설정파일 변경사항
<logger category="org.jboss.as.clustering.web.infinispan">
    <level name="TRACE"/>
</logger>

 
3. Async Handler 설정
1) 관리콘솔

- Async Handler 추가

화면메뉴: Profile - Core - Logging - Handler - Async - Add
Icon

Name: async-handler-1

Queue Length: 1024

Log Level: INFO

Overflow Action: BLOCK

 

- Async Handler를 통해 사용할 Handler 설정

화면메뉴: Profile - Core - Logging - Handler - Async - Detail - Handler 에서 FILE 핸들러를 추가한다.
2) standalone.xml
            <async-handler name="async-handler-1">
                <level name="INFO"/>
                <queue-length value="512"/>
                <overflow-action value="block"/>
                <subhandlers>
                    <handler name="FILE"/>
                </subhandlers>
            </async-handler>
...
            <root-logger>
                <level name="INFO"/>
                <handlers>
                    <handler name="CONSOLE"/>
                    <handler name="async-handler-1"/>
                </handlers>
            </root-logger>

 

4. Application별 Logging설정

https://access.redhat.com/solutions/105653

 

EAP6.3에서는 Log4j만 사용할 경우 특별한 설정을 하지 않아도 별도로 로그파일을 분리할 수 있다.

하지만 EAP6.2에서는 Logger를 사용한 로깅 이외에 System.out으로 출력하는 로그를 로깅할 수 없었다.

 
 	EAP6.2	EAP6.3
 	CONSOLE	FILE	myappender생성	myappender로깅	

myappender에
SystemOut출력
	CONSOLE	FILE	myappender생성	myappender로깅	

myappender에
SystemOut출력
기본설정	X	X	O	O	X	X	X	O	O	O
per-deployment=false 추가	O	O	X	X	X	O	O	X	X	X

per-deployment=false 추가
jboss-development-structure.xml추가
	O	O	

X

(app 호출시생성)
	O	X	O	O	

X

(app 호출시생성)
	O	X

 

Application의 Log4j설정
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
<log4j:configuration debug="true"
    xmlns:log4j='http://jakarta.apache.org/log4j/'>
    <appender name="myappender" class="org.apache.log4j.RollingFileAppender">
       <param name="append" value="false" />
       <param name="maxFileSize" value="10KB" />
       <param name="maxBackupIndex" value="5" />
       <param name="file" value="/home/hsyang/tmp/mylog4j-App.log" />
       <layout class="org.apache.log4j.PatternLayout">
        <param name="ConversionPattern"
            value="%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n" />
       </layout>
    </appender>
    <root>
        <level value="INFO" />
        <appender-ref ref="myappender" />
    </root>
</log4j:configuration>

 

 
Application별 로그설정이 필요한 경우

    어플리케이션에 별도로 log4j.xml이 포함되어 있고 별도 파일로 로깅을 설정했는데 어플리케이션 로그가 모두 server.log에 로깅될 때
    메세지가 server.log에 기록되지 않는 경우(어플리케이션에서 slf4j를 사용하고 WAR로 Deploy했는데 어떤 로그도 기록되지 않음)
    JBoss 설정파일 이외에 별도로 어플리케이션의 Log4j 설정을 유지하고 싶을때

    로깅이 제대로 되지 않으며 아래와 같은 메세지를 보일때
    16:17:03,188 INFO  [stdout] (Finalizer) log4j: Finalizing appender named [myAppender1].
    16:17:03,189 INFO  [stdout] (Finalizer) log4j: Finalizing appender named [myAppender2].

Application별 로그설정방법 요약

    어플리케이션의 라이브러리 디렉토리에 log4j.jar 복사
    System property에  -Dorg.jboss.as.logging.per-deployment=false 추가 'Ref'
    JBoss의 로깅모듈을 제외하기위해 jboss-deployment-structure.xml를 WEB-INF 또는 META-INF에 생성
    Classpath에 어플리케이션별 Log4J 설정 추가 (log4j.xml 또는 log4j.properties)

 

log4j.xml 샘플 (1.2.x)
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
<log4j:configuration debug="true"
    xmlns:log4j='http://jakarta.apache.org/log4j/'>
     
    <appender name="myappender" class="org.apache.log4j.RollingFileAppender">
       <param name="append" value="false" />
       <param name="maxFileSize" value="10KB" />
       <param name="maxBackupIndex" value="5" />
       <param name="file" value="/home/hsyang/tmp/log4j-App.log" />
       <layout class="org.apache.log4j.PatternLayout">
        <param name="ConversionPattern"
            value="%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n" />
       </layout>
    </appender>
    <root>
        <level value="info" />
        <appender-ref ref="file" />
    </root>
</log4j:configuration>
Icon

appender 명은 CONSOLE 또는 FILE 이 사용되면 파일에 로그가 쌓이지 않는다.

CONSOLE 또는 FILE은 JBoss의 Log Manager에서 사용중이므로 해당 이름을 사용하면 않된다.

Application의 log4j에서 JBoss의 CONSOLE 또는 FILE Appender를 참조할 수 없다.


 

 

Deployment별로 Log Context를 초기화시키지 않음

JBoss Logging Framework에서 Log Configuration 파일을 읽지 않게 설정한다.

env.sh
# JBoss Logging Framework에서 Deployment별로 Log Context를 초기화시키지 않음
-Dorg.jboss.as.logging.per-deployment=false

 

JBoss의 로깅모듈을 제외
jboss-deployment-structure.xml
<jboss-deployment-structure>
  <deployment>
    <exclusions>
      <module name="org.apache.commons.logging" />
      <module name="org.apache.log4j" />
      <module name="org.slf4j" />
    </exclusions>
  </deployment>
</jboss-deployment-structure>

 
JBoss Logging Framework의 기본동작설명

어플리케이션이 배포되면 배포시점에 JBoss는 다음과 같은 로그설정파일을 찾는다.

log4.properties,log4j.xml, jboss-log4j.xml, jboss-logging.properties or logging.properties

만약 이중에 1개의 파일을 발견하면 해당 파일을 사용하여 새로운 Log Context를 생성한다.

따라서 log4j.jar를 추가하지 않아도 새로운 Appender를 이용하여 별도의 로그파일을 생성할 수 있다.

 

만약 아래와 같은 로그나 나오면 JBoss의 Log4j가 사용된 것이다.
16:17:03,188 INFO  [stdout] (Finalizer) log4j: Finalizing appender named [myAppender1].
16:17:03,189 INFO  [stdout] (Finalizer) log4j: Finalizing appender named [myAppender2].

 

어플리케이션에서 현재 사용되는 Log4j Implementation 이름 확인방법
System.out.println(Logger.class.getPackage().getImplementationTitle());
System.out.println(Logger.class.getPackage().getImplementationVendor());
System.out.println(Logger.class.getPackage().getImplementationVersion());
 
결과:
[stdout] log4j-jboss-logmanager
[stdout] JBoss by Red Hat
[stdout] 1.0.2.Final-redhat-1
